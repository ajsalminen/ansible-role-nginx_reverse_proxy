server {
    listen {{nginx_port}};

#    access_log  /var/log/nginx/default.access.log;

{% if nginx_reverse_proxy_root is defined %}
    root {{sites_dir}}/{{ site_name ~ local_test_environment|default('') }}/www;
    server_name {{ apache_host ~ local_test_environment|default('') }} {{ 'www.' ~ apache_host ~ local_test_environment|default('') }};

    location ~ .(gif|jpg|jpeg|png|js|css|ico)$ {
        try_files $uri @proxy;
    }


location ~ /files/styles/ {
 # expires 2h;
 try_files $uri @proxy;
 }
{% endif %}

{% if site_specific is defined %}
{{site_specific}}
{% endif %}
# Everything that needs to pass without caching goes through this.
    location @proxy {
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_hide_header {{nginx_proxy_hide_header}};
        proxy_pass http://{{ apache_host ~ local_test_environment|default('') }}:{{apache_port}};
    }


    location / {
   # queries (maybe), drupal cookies, or not GET methods, all require PHP processing.
{% if disable_cache_if_query_params is defined %}
    if ($query_string ~ ".+") {
      return 405;
    }{% endif %}
    if ($http_cookie ~ "DRUPAL_UID" ) {
      return 405;
    }
    if ($request_method !~ ^(GET|HEAD|PURGE)$ ) {
      return 405;
    }
    error_page 405 = @proxy;

    include proxy_cache_options;
    proxy_pass http://{{apache_host  ~ local_test_environment|default('')}}:{{apache_port}};
    }

}
